<script>import { onMount } from "svelte";
import { getToolbarSrc } from "@prismicio/client";
import { beforeNavigate, goto, invalidateAll } from "$app/navigation";
export let repositoryName;
export let routePrefix = "preview";
export let routePrefixName = routePrefix;
$:
  toolbarSrc = getToolbarSrc(repositoryName);
let endingPreview = false;
onMount(() => {
  const controller = new AbortController();
  window.addEventListener(
    "prismicPreviewUpdate",
    (event) => {
      event.preventDefault();
      invalidateAll();
    },
    { signal: controller.signal }
  );
  window.addEventListener(
    "prismicPreviewEnd",
    (event) => {
      event.preventDefault();
      endingPreview = true;
      goto(
        new URL(
          window.location.pathname.replace(
            new RegExp(`^(/${routePrefix}/?$|/${routePrefix}/)`),
            "/"
          ),
          window.location.origin
        ),
        {
          invalidateAll: true,
          noScroll: true
        }
      );
    },
    { signal: controller.signal }
  );
  return () => {
    controller.abort();
  };
});
beforeNavigate((navigation) => {
  if (navigation.to && navigation.from?.params?.[routePrefixName] === routePrefix && !(routePrefixName in (navigation.to.params || {}))) {
    if (endingPreview) {
      endingPreview = false;
      return;
    }
    navigation.cancel();
    goto(
      new URL(
        routePrefix + navigation.to.url.pathname,
        navigation.to.url.origin
      )
    );
  }
});
</script>

<svelte:head>
	<script defer src={toolbarSrc}></script>
</svelte:head>
